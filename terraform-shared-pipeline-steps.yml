parameters:
  vmImage: ''           # Agent`s images
  terraformVersion: ''  # Terraform version

steps:
  - task: DownloadSecureFile@1
    name: secrets
    displayName: 'Download secrets'
    inputs:
      secureFile: secrets.tfvars

  - task: CopyFiles@2
    displayName: 'Copy secrets'
    inputs:
      SourceFolder: '$(Agent.TempDirectory)'
      Contents: '$(secrets.secureFilePath)'
      TargetFolder: '$(Agent.BuildDirectory)'

  - task: CopyFiles@2
    displayName: 'Copy terraform files'
    inputs:
      SourceFolder: '$(Build.Repository.LocalPath)'
      Contents: |
        **
      TargetFolder: '$(Agent.BuildDirectory)'

  - task: replacetokens@3
    displayName: 'Replace tokens'
    inputs:
      rootDirectory: '$(Agent.BuildDirectory)'
      targetFiles: |
        *.tf
        *.tfvars
      encoding: 'auto'
      writeBOM: true
      escapeType: 'none'
      actionOnMissing: 'warn'
      keepToken: false
      tokenPrefix: '#{'
      tokenSuffix: '}#'

  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: ${{ parameters.terraformVersion }}

  - task: TerraformTaskV1@0
    displayName: 'Terraform : init'
    inputs:
      workingDirectory: '$(Agent.BuildDirectory)'
      backendServiceArm: 'isolated test (a6edf9da-b31a-48ac-b34d-1a9673e0908c)'
      backendAzureRmResourceGroupName: '$(storageresourcegroup)'
      backendAzureRmStorageAccountName: '$(storageaccount)'
      backendAzureRmContainerName: '$(storageblob)'
      backendAzureRmKey: '$(tfstate)'

  - task: TerraformTaskV1@0
    displayName: 'Terraform: plan'
    inputs:
      command: plan
      workingDirectory: '$(Agent.BuildDirectory)'
      commandOptions: '-var-file=secrets.tfvars'
      environmentServiceNameAzureRM: 'isolated test (a6edf9da-b31a-48ac-b34d-1a9673e0908c)'

  - task: TerraformTaskV1@0
    displayName: 'Terraform: apply'
    condition: and(succeeded(), in(variables['env'], 'dev', 'qa', 'uat', 'prod'))
    #    condition: and(succeeded(), eq(variables['env'], 'dev', 'qa', 'uat, 'prod'))
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: '$(Agent.BuildDirectory)'
      commandOptions: '-auto-approve -input=false -var-file=secrets.tfvars'
      environmentServiceNameAzureRM: 'isolated test (a6edf9da-b31a-48ac-b34d-1a9673e0908c)'